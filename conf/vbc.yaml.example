# VBC Configuration Example
# All available parameters with descriptions

# --- Input/Output Settings ---

# List of directories to scan for videos.
# CLI argument overrides this (no merge).
input_dirs:
  - /path/to/videos
  - /another/path

# Explicit output directories (one per input directory, in order).
# Must have the same count as input_dirs.
# Cannot be used if suffix_output_dirs is set.
output_dirs: []

# Suffix appended to each input directory name to create output directory.
# Example: /videos -> /videos_out
# Default: "_out"
suffix_output_dirs: "_out"

# Explicit directories for failed files (one per input directory, in order).
# Cannot be used if suffix_errors_dirs is set.
errors_dirs: []

# Suffix appended to each input directory name for failed files.
# After processing, failed source files and their .err markers are moved here.
# Default: "_err"
suffix_errors_dirs: "_err"

# --- General Settings ---

general:
  # Max concurrent compression threads (1-16).
  # Can be adjusted at runtime with < and > keys.
  threads: 4

  # Submit-on-demand queue multiplier (1-5).
  # Formula: max_queued = prefetch_factor * threads.
  prefetch_factor: 1

  # Use GPU acceleration (NVENC AV1) if true, otherwise CPU (SVT-AV1).
  gpu: true

  # GPU polling interval in updates per second (legacy, see gpu_config).
  gpu_refresh_rate: 5

  # Processing order: name, rand, dir, size, size-asc, size-desc, ext.
  queue_sort: "name"

  # Optional seed for deterministic random queue sorting.
  queue_seed: null

  # Path to log file. Default: /tmp/vbc/compression.log
  log_path: "/tmp/vbc/compression.log"

  # Retry on CPU if NVENC hits hardware capability error.
  cpu_fallback: false

  # Max CPU threads per FFmpeg worker (null = auto).
  ffmpeg_cpu_threads: null

  # Copy EXIF/XMP/GPS tags from source to output.
  copy_metadata: true

  # Use ExifTool for deep metadata analysis (required for dynamic_quality/filtering).
  use_exif: true

  # Only process specific camera models (substring match, case-insensitive).
  # Example: ["Sony", "DJI"]
  filter_cameras: []

  # Camera-specific quality rules (first match wins).
  # NOTE: Legacy scalar format is NOT supported:
  #   dynamic_quality: {"Sony": 35}
  # Use object format with explicit cq and optional rate settings:
  dynamic_quality:
    "ILCE-7RM5":
      cq: 35
      rate:
        bps: "0.8"
        minrate: "0.7"
        maxrate: "0.9"
        rate_target_max_bps: "95M"
    "DJI":
      cq: 40
      rate:
        bps: "180M"

  # Quality control mode:
  # - "cq": uses encoder args -cq/-crf (default behavior)
  # - "rate": uses bitrate target bps/minrate/maxrate
  quality_mode: "cq"

  # Bitrate target for quality_mode="rate".
  # Accepted absolute formats: 200000000, 200000k, 200M, 200Mbps
  # Accepted relative format: 0.8 (input bitrate * 0.8)
  bps: null

  # Optional VBR clamp values for quality_mode="rate".
  # Must use the same numeric class as bps (all absolute or all relative).
  minrate: null
  maxrate: null

  # Optional hard cap applied after bps/minrate/maxrate resolution.
  # Absolute only (e.g. 95M, 100Mbps, 100000k, 100000000).
  # NOTE: Caps target bitrate, not instantaneous peak bitrate.
  rate_target_max_bps: null

  # Example rate mode (global absolute):
  # quality_mode: "rate"
  # bps: "200Mbps"
  # minrate: "180Mbps"
  # maxrate: "220Mbps"
  # rate_target_max_bps: "95Mbps"

  # Example rate mode (global relative):
  # quality_mode: "rate"
  # bps: "0.8"
  # minrate: "0.7"
  # maxrate: "0.9"
  # rate_target_max_bps: "95Mbps"

  # File extensions to scan and process.
  extensions:
    - ".mp4"
    - ".mov"
    - ".avi"
    - ".flv"
    - ".webm"

  # Minimum input file size in bytes to process (Default: 1 MiB).
  min_size_bytes: 1048576

  # Remove existing .err markers on startup and retry those files.
  clean_errors: false

  # Skip files already encoded in AV1 codec.
  skip_av1: false

  # Replace non-ASCII characters with '?' in UI to prevent alignment issues.
  strip_unicode_display: true

  # Global rotation override (null, 0, 90, 180, 270).
  manual_rotation: null

  # Minimum compression savings required (0.0-1.0).
  # If compression < 10%, keep original file instead of compressed version.
  min_compression_ratio: 0.1

  # Attempt to repair corrupted FLV/MP4 files (text prefix error).
  repair_corrupted_flv: false

  # Enable verbose debug logging.
  debug: false

# --- GPU Monitoring Settings ---

gpu_config:
  # Enable GPU monitoring panel and sparklines.
  enabled: true

  # How often to sample GPU metrics (seconds).
  sample_interval_s: 5.0

  # Total time window shown in sparklines (seconds).
  history_window_s: 300.0

  # Index of the GPU device to monitor.
  nvtop_device_index: 0

  # Optional: specific device name to monitor (overrides index).
  nvtop_device_name: null

  # Optional: custom path to nvtop binary (auto-detected if not set).
  # Useful when multiple nvtop versions installed (e.g., /usr/local/bin/nvtop).
  nvtop_path: null

# --- GPU Encoder Settings ---

gpu_encoder:
  # Use advanced_args instead of common_args when true.
  advanced: false

  # Base NVENC args (used when advanced=false).
  common_args:
    - "-c:v av1_nvenc"
    - "-preset p7"
    - "-tune hq"
    - "-b:v 0"
    - "-cq 45"
    - "-f mp4"

  # Full NVENC args (used when advanced=true).
  advanced_args:
    - "-c:v av1_nvenc"
    - "-preset p7"
    - "-tune hq"
    - "-b:v 0"
    - "-cq 45"
    - "-rc vbr"
    - "-multipass fullres"
    - "-rc-lookahead 32"
    - "-spatial-aq 1"
    - "-temporal-aq 1"
    - "-aq-strength 8"
    - "-b_ref_mode middle"
    - "-f mp4"

# --- CPU Encoder Settings ---

cpu_encoder:
  # Use advanced_args instead of common_args when true.
  advanced: false

  # Base SVT-AV1 args (used when advanced=false).
  common_args:
    - "-c:v libsvtav1"
    - "-preset 6"
    - "-crf 32"
    - "-svtav1-params tune=0:enable-overlays=1"
    - "-f mp4"

  # Enforce input pix_fmt when advanced=true (adds -pix_fmt from ffprobe).
  advanced_enforce_input_pix_fmt: true

  # Full CPU args (used when advanced=true).
  advanced_args:
    - "-c:v libaom-av1"
    - "-crf 30"
    - "-b:v 0"
    - "-cpu-used 0"
    - "-tune ssim"
    - "-lag-in-frames 35"
    - "-aq-mode 1"
    - "-row-mt 1"
    - "-threads 0"
    - "-f matroska"

# --- UI Settings ---

ui:
  # Max events shown in the activity feed panel (1-20).
  activity_feed_max_items: 5

  # Max concurrent jobs to display in the active panel (1-16).
  active_jobs_max_display: 8

  # Vertical scaling factor for dashboard panels (0.3-1.0).
  panel_height_scale: 0.7

# --- Auto-Rotation Settings ---

autorotate:
  # Regex pattern -> Rotation angle (0, 90, 180, 270).
  # First match wins.
  patterns:
    "GOPR\d+\.MP4": 180
    "IMG_\d{4}\.MOV": 90
